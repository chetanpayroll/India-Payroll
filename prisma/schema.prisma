// PayrollNexus India - Complete Prisma Schema
// Multi-tenant Payroll Engine with Formula Engine & Statutory Compliance

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model Vendor {
  id            String   @id @default(cuid())
  name          String
  code          String   @unique
  contactEmail  String
  status        VendorStatus @default(ACTIVE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clients       Client[]
  users         User[]
  auditLogs     AuditLog[]

  @@map("vendors")
}

model Client {
  id            String   @id @default(cuid())
  vendorId      String
  name          String
  code          String   @unique
  businessType  String
  panNumber     String   @unique
  tanNumber     String?
  gstNumber     String?
  address       Json     // { line1, city, state, pincode }
  status        ClientStatus @default(ACTIVE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  vendor        Vendor   @relation(fields: [vendorId], references: [id])
  entities      Entity[]
  employees     Employee[]
  payElements   PayElement[]
  statutoryConfigs StatutoryConfig[]
  users         User[]
  auditLogs     AuditLog[]

  @@index([vendorId])
  @@map("clients")
}

model Entity {
  id              String   @id @default(cuid())
  clientId        String
  name            String
  legalName       String
  state           String
  registrationNo  String?
  pfCode          String?
  esiCode         String?
  ptRegistration  String?
  tanNumber       String?
  bankDetails     Json?    // { bank_name, account_number, ifsc_code, branch }
  payrollCalendar Json?    // { working_days, cutoff_day, pay_day }
  status          EntityStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client          Client   @relation(fields: [clientId], references: [id])
  employees       Employee[]
  payElements     PayElement[]
  statutoryConfigs StatutoryConfig[]
  payrollRuns     PayrollRun[]

  @@index([clientId])
  @@map("entities")
}

model User {
  id            String   @id @default(cuid())
  vendorId      String?
  clientId      String?
  email         String   @unique
  name          String
  role          UserRole
  passwordHash  String   // In demo mode: always "demo-mode-no-validation"
  status        UserStatus @default(ACTIVE)
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  vendor        Vendor?  @relation(fields: [vendorId], references: [id])
  client        Client?  @relation(fields: [clientId], references: [id])
  
  createdPayElements    PayElement[] @relation("CreatedPayElements")
  approvedPayElements   PayElement[] @relation("ApprovedPayElements")
  processedPayrollRuns  PayrollRun[] @relation("ProcessedPayrollRuns")
  approvedPayrollRuns   PayrollRun[] @relation("ApprovedPayrollRuns")
  postedPayrollRuns     PayrollRun[] @relation("PostedPayrollRuns")
  auditLogs             AuditLog[]

  @@index([vendorId])
  @@index([clientId])
  @@map("users")
}

// ============================================================================
// EMPLOYEE MANAGEMENT
// ============================================================================

model Employee {
  id              String   @id @default(cuid())
  clientId        String
  entityId        String
  employeeCode    String
  firstName       String
  lastName        String
  email           String?
  dob             DateTime?
  gender          String?
  joiningDate     DateTime
  resignationDate DateTime?
  designation     String?
  department      String?
  costCenter      String?
  bankName        String?
  bankAccount     String?
  ifscCode        String?
  panNumber       String?
  uanNumber       String?
  esicNumber      String?
  aadharNumber    String?  // Should be encrypted in production
  status          EmployeeStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client          Client   @relation(fields: [clientId], references: [id])
  entity          Entity   @relation(fields: [entityId], references: [id])
  
  payConfig       EmployeePayConfig[]
  payrollLineItems PayrollLineItem[]
  payslips        Payslip[]

  @@unique([clientId, employeeCode])
  @@index([clientId])
  @@index([entityId])
  @@map("employees")
}

// ============================================================================
// PAY ELEMENTS & FORMULA ENGINE
// ============================================================================

model PayElement {
  id                String   @id @default(cuid())
  clientId          String
  entityId          String?  // null = client-wide
  code              String
  name              String
  description       String?
  elementType       ElementType
  calculationType   CalculationType
  value             Decimal? // For FIXED/PERCENTAGE
  baseElementCode   String?  // For PERCENTAGE
  formula           Json?    // { type, expression, references, description }
  slabConfig        Json?    // For SLAB type (PT, TDS)
  isTaxable         Boolean  @default(true)
  isPfApplicable    Boolean  @default(false)
  isEsiApplicable   Boolean  @default(false)
  isPtApplicable    Boolean  @default(false)
  isMonthlyVariable Boolean  @default(false)
  displayOrder      Int      @default(0)
  effectiveFrom     DateTime
  effectiveTo       DateTime?
  version           Int      @default(1)
  isApproved        Boolean  @default(false)
  approvedBy        String?
  approvedAt        DateTime?
  createdBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  client            Client   @relation(fields: [clientId], references: [id])
  entity            Entity?  @relation(fields: [entityId], references: [id])
  creator           User     @relation("CreatedPayElements", fields: [createdBy], references: [id])
  approver          User?    @relation("ApprovedPayElements", fields: [approvedBy], references: [id])
  
  versions          PayElementVersion[]
  employeeConfigs   EmployeePayConfig[]

  @@unique([clientId, code])
  @@index([clientId])
  @@index([entityId])
  @@map("pay_elements")
}

model PayElementVersion {
  id            String   @id @default(cuid())
  payElementId  String
  version       Int
  snapshot      Json     // Full element data at this version
  changeReason  String?
  createdBy     String
  createdAt     DateTime @default(now())

  payElement    PayElement @relation(fields: [payElementId], references: [id])

  @@unique([payElementId, version])
  @@map("pay_element_versions")
}

model EmployeePayConfig {
  id              String   @id @default(cuid())
  employeeId      String
  payElementId    String
  overrideType    OverrideType?
  overrideValue   Decimal?
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  createdBy       String
  createdAt       DateTime @default(now())

  employee        Employee   @relation(fields: [employeeId], references: [id])
  payElement      PayElement @relation(fields: [payElementId], references: [id])

  @@index([employeeId])
  @@index([payElementId])
  @@map("employee_pay_configs")
}

// ============================================================================
// STATUTORY CONFIGURATION
// ============================================================================

model StatutoryConfig {
  id            String   @id @default(cuid())
  clientId      String
  entityId      String?
  configType    StatutoryType
  configData    Json     // { rates, thresholds, slabs }
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isActive      Boolean  @default(true)
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client        Client   @relation(fields: [clientId], references: [id])
  entity        Entity?  @relation(fields: [entityId], references: [id])

  @@index([clientId])
  @@index([entityId])
  @@map("statutory_configs")
}

// ============================================================================
// PAYROLL PROCESSING
// ============================================================================

model PayrollRun {
  id                    String   @id @default(cuid())
  clientId              String
  entityId              String
  runCode               String   @unique
  periodStart           DateTime
  periodEnd             DateTime
  payDate               DateTime
  status                PayrollStatus @default(DRAFT)
  totalGross            Decimal  @default(0)
  totalDeductions       Decimal  @default(0)
  totalNet              Decimal  @default(0)
  totalEmployerCost     Decimal  @default(0)
  employeeCount         Int      @default(0)
  processedBy           String?
  processedAt           DateTime?
  approvedBy            String?
  approvedAt            DateTime?
  postedBy              String?
  postedAt              DateTime?
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  entity                Entity   @relation(fields: [entityId], references: [id])
  processor             User?    @relation("ProcessedPayrollRuns", fields: [processedBy], references: [id])
  approver              User?    @relation("ApprovedPayrollRuns", fields: [approvedBy], references: [id])
  poster                User?    @relation("PostedPayrollRuns", fields: [postedBy], references: [id])
  
  lineItems             PayrollLineItem[]
  payslips              Payslip[]

  @@index([entityId])
  @@index([status])
  @@map("payroll_runs")
}

model PayrollLineItem {
  id                      String   @id @default(cuid())
  payrollRunId            String
  employeeId              String
  grossSalary             Decimal
  totalEarnings           Decimal
  totalDeductions         Decimal
  netSalary               Decimal
  employerContributions   Decimal
  ctc                     Decimal
  workingDays             Int
  paidDays                Decimal
  lopDays                 Decimal
  earningsBreakdown       Json     // { element_code: amount }
  deductionsBreakdown     Json
  employerBreakdown       Json
  statutoryBreakdown      Json     // { epf, esi, pt, tds, etc. }
  computationLog          Json     // Detailed calculation trace
  status                  LineItemStatus @default(CALCULATED)
  errorMessage            String?
  createdAt               DateTime @default(now())

  payrollRun              PayrollRun @relation(fields: [payrollRunId], references: [id])
  employee                Employee   @relation(fields: [employeeId], references: [id])
  
  payslip                 Payslip?

  @@index([payrollRunId])
  @@index([employeeId])
  @@map("payroll_line_items")
}

model Payslip {
  id                  String   @id @default(cuid())
  payrollRunId        String
  payrollLineItemId   String   @unique
  employeeId          String
  payslipNumber       String   @unique
  payslipHtml         String   @db.Text
  payslipPdfUrl       String?
  generatedAt         DateTime @default(now())
  distributed         Boolean  @default(false)
  distributedAt       DateTime?
  createdAt           DateTime @default(now())

  payrollRun          PayrollRun      @relation(fields: [payrollRunId], references: [id])
  lineItem            PayrollLineItem @relation(fields: [payrollLineItemId], references: [id])
  employee            Employee        @relation(fields: [employeeId], references: [id])

  @@index([payrollRunId])
  @@index([employeeId])
  @@map("payslips")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id            String   @id @default(cuid())
  vendorId      String?
  clientId      String?
  actorId       String
  actorEmail    String
  action        AuditAction
  resourceType  String
  resourceId    String?
  beforeState   Json?
  afterState    Json?
  ipAddress     String?
  userAgent     String?
  timestamp     DateTime @default(now())

  vendor        Vendor?  @relation(fields: [vendorId], references: [id])
  client        Client?  @relation(fields: [clientId], references: [id])
  actor         User     @relation(fields: [actorId], references: [id])

  @@index([vendorId])
  @@index([clientId])
  @@index([actorId])
  @@index([resourceType, resourceId])
  @@index([timestamp])
  @@map("audit_logs")
}

// ============================================================================
// ENUMS
// ============================================================================

enum VendorStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum EntityStatus {
  ACTIVE
  INACTIVE
}

enum UserRole {
  VENDOR_ADMIN
  VENDOR_EMPLOYEE
  VENDOR_SUPPORT
  CLIENT_ADMIN
  PAYROLL_PROCESSOR
  PAYROLL_APPROVER
  CLIENT_VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  RESIGNED
  TERMINATED
}

enum ElementType {
  EARNING
  DEDUCTION
  STATUTORY
  REIMBURSEMENT
  EMPLOYER_CONTRIBUTION
}

enum CalculationType {
  FIXED
  PERCENTAGE
  FORMULA
  SLAB
}

enum OverrideType {
  FIXED_VALUE
  PERCENTAGE_OVERRIDE
  DISABLED
}

enum StatutoryType {
  EPF
  ESI
  PT
  TDS
  LWF
}

enum PayrollStatus {
  DRAFT
  PROCESSING
  CALCULATED
  PENDING_APPROVAL
  APPROVED
  POSTED
  CANCELLED
}

enum LineItemStatus {
  CALCULATED
  ERROR
  EXCLUDED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  APPROVE
  PROCESS
  POST
  LOGIN
  LOGOUT
}
