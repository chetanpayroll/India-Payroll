// GMP Payroll - Enterprise Scale Schema
// Version: 2.0 (Production Ready)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// 1. AUTHENTICATION & USER MANAGEMENT
// ============================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique @db.VarChar(255)
  password      String    @map("password_hash") @db.VarChar(255)
  name          String    @db.VarChar(255)
  role          String    @default("employee") @db.VarChar(50) // super_admin, admin, manager, hr, finance, employee
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")
  createdBy     String?   @map("created_by") // UUID
  updatedBy     String?   @map("updated_by") // UUID

  sessions      Session[]
  companyUsers  CompanyUser[]
  auditLogs     AuditLog[]
  
  // Relations for tracking
  createdCompanies Company[] @relation("CreatedBy")
  updatedCompanies Company[] @relation("UpdatedBy")

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================================================
// 2. COMPANY MANAGEMENT (MULTI-TENANT)
// ============================================================

model Company {
  id                    String   @id @default(uuid())
  name                  String   @db.VarChar(255)
  legalName             String   @map("legal_name") @db.VarChar(255)
  registrationNumber    String?  @map("registration_number") @db.VarChar(100)
  
  // Indian Tax Identifiers
  pan                   String   @unique @db.VarChar(10)
  tan                   String?  @db.VarChar(10)
  gstin                 String?  @db.VarChar(15)
  
  // Statutory Registrations
  pfRegistrationNumber  String?  @map("pf_registration_number") @db.VarChar(50)
  pfEstablishmentId     String?  @map("pf_establishment_id") @db.VarChar(50)
  esicRegistrationNumber String? @map("esic_registration_number") @db.VarChar(50)
  ptRegistrationNumber  String?  @map("pt_registration_number") @db.VarChar(50)
  lwfRegistrationNumber String?  @map("lwf_registration_number") @db.VarChar(50)
  
  // Address
  addressLine1          String?  @map("address_line1") @db.VarChar(255)
  addressLine2          String?  @map("address_line2") @db.VarChar(255)
  city                  String?  @db.VarChar(100)
  state                 String?  @db.VarChar(100)
  postalCode            String?  @map("postal_code") @db.VarChar(10)
  country               String   @default("India") @db.VarChar(100)
  
  // Contact
  phone                 String?  @db.VarChar(20)
  email                 String?  @db.VarChar(255)
  website               String?  @db.VarChar(255)
  
  // Bank
  bankName              String?  @map("bank_name") @db.VarChar(255)
  bankAccountNumber     String?  @map("bank_account_number") @db.VarChar(50)
  bankIfsc              String?  @map("bank_ifsc") @db.VarChar(11)
  bankBranch            String?  @map("bank_branch") @db.VarChar(255)
  
  // Meta
  industry              String?  @db.VarChar(100)
  employeeCount         Int      @default(0) @map("employee_count")
  financialYearStart    Int      @default(4) @map("financial_year_start") // April
  isActive              Boolean  @default(true) @map("is_active")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at")
  createdById           String?  @map("created_by")
  updatedById           String?  @map("updated_by")

  createdBy             User?    @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy             User?    @relation("UpdatedBy", fields: [updatedById], references: [id])

  employees             Employee[]
  payrollRuns           PayrollRun[]
  attendanceRecords     AttendanceRecord[]
  leaveTypes            LeaveType[]
  complianceLogs        ComplianceLog[]
  companyUsers          CompanyUser[]
  loans                 Loan[]
  systemSettings        SystemSetting[]

  @@index([pan])
  @@index([isActive])
  @@map("companies")
}

model CompanyUser {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  userId      String   @map("user_id")
  role        String   @db.VarChar(50) // admin, manager, hr, finance
  permissions Json?    // Granular permissions
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@map("company_users")
}

// ============================================================================
// 3. EMPLOYEE MASTER DATA
// ============================================================

model Employee {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")
  
  // Basic Info
  employeeCode          String    @map("employee_code") @db.VarChar(50)
  title                 String?   @db.VarChar(10)
  firstName             String    @map("first_name") @db.VarChar(100)
  middleName            String?   @map("middle_name") @db.VarChar(100)
  lastName              String    @map("last_name") @db.VarChar(100)
  
  // Personal
  dateOfBirth           DateTime? @map("date_of_birth") @db.Date
  gender                String?   @db.VarChar(20)
  maritalStatus         String?   @map("marital_status") @db.VarChar(20)
  bloodGroup            String?   @map("blood_group") @db.VarChar(5)
  
  // Contact
  email                 String?   @db.VarChar(255)
  personalEmail         String?   @map("personal_email") @db.VarChar(255)
  mobile                String?   @db.VarChar(15)
  currentAddressLine1   String?   @map("current_address_line1") @db.VarChar(255)
  currentCity           String?   @map("current_city") @db.VarChar(100)
  
  // Employment
  dateOfJoining         DateTime  @map("date_of_joining") @db.Date
  dateOfLeaving         DateTime? @map("date_of_leaving") @db.Date
  employmentType        String    @default("Permanent") @map("employment_type") @db.VarChar(20)
  status                String    @default("Active") @db.VarChar(20)
  department            String?   @db.VarChar(100)
  designation           String?   @db.VarChar(100)
  location              String?   @map("work_location") @db.VarChar(100)
  reportingManagerId    String?   @map("reporting_manager_id")
  
  // Statutory
  pan                   String?   @db.VarChar(10)
  aadhaar               String?   @db.VarChar(12)
  uan                   String?   @db.VarChar(12)
  esicIpNumber          String?   @map("esic_ip_number") @db.VarChar(17)
  
  // Bank
  bankAccountNumber     String?   @map("bank_account_number") @db.VarChar(50)
  bankIfsc              String?   @map("bank_ifsc") @db.VarChar(11)
  bankName              String?   @map("bank_name") @db.VarChar(100)
  
  // Metadata
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  company               Company   @relation(fields: [companyId], references: [id])
  manager               Employee? @relation("ReportingManager", fields: [reportingManagerId], references: [id])
  subordinates          Employee[] @relation("ReportingManager")
  
  salaryStructure       SalaryStructure?
  attendanceRecords     AttendanceRecord[]
  leaveBalances         LeaveBalance[]
  leaveApplications     LeaveApplication[]
  investmentDeclarations InvestmentDeclaration[]
  loans                 Loan[]
  payrollDetails        PayrollDetail[]

  @@unique([companyId, employeeCode])
  @@index([companyId])
  @@index([status])
  @@index([department])
  @@map("employees")
}

// ============================================================================
// 4. SALARY STRUCTURE
// ============================================================

model SalaryStructure {
  id                String    @id @default(uuid())
  employeeId        String    @unique @map("employee_id")
  effectiveFrom     DateTime  @map("effective_from") @db.Date
  effectiveTo       DateTime? @map("effective_to") @db.Date
  
  // Components
  basicSalary       Decimal   @map("basic_salary") @db.Decimal(12, 2)
  hra               Decimal?  @default(0) @db.Decimal(12, 2)
  specialAllowance  Decimal?  @default(0) @map("special_allowance") @db.Decimal(12, 2)
  transportAllowance Decimal? @default(0) @map("transport_allowance") @db.Decimal(12, 2)
  medicalAllowance  Decimal?  @default(0) @map("medical_allowance") @db.Decimal(12, 2)
  lta               Decimal?  @default(0) @db.Decimal(12, 2)
  otherAllowances   Decimal?  @default(0) @map("other_allowances") @db.Decimal(12, 2)
  
  // Calculated (can be computed, but stored for ease)
  // grossSalary omitted, calculated at runtime or app level

  // Applicability
  pfApplicable      Boolean   @default(true) @map("pf_applicable")
  esicApplicable    Boolean   @default(false) @map("esic_applicable")
  ptApplicable      Boolean   @default(true) @map("pt_applicable")
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  employee          Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([effectiveFrom])
  @@map("salary_structures")
}

// ============================================================================
// 5. ATTENDANCE
// ============================================================

model AttendanceRecord {
  id                String    @id @default(uuid())
  employeeId        String    @map("employee_id")
  companyId         String    @map("company_id")
  attendanceDate    DateTime  @map("attendance_date") @db.Date
  
  status            String    @db.VarChar(20) // Present, Absent, Half Day, Leave
  checkInTime       DateTime? @map("check_in_time") @db.Time
  checkOutTime      DateTime? @map("check_out_time") @db.Time
  totalHours        Decimal?  @map("total_hours") @db.Decimal(5, 2)
  
  overtimeHours     Decimal?  @default(0) @map("overtime_hours") @db.Decimal(5, 2)
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  employee          Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  company           Company   @relation(fields: [companyId], references: [id])

  @@unique([employeeId, attendanceDate])
  @@index([companyId, attendanceDate])
  @@map("attendance_records")
}

// ============================================================================
// 6. LEAVES
// ============================================================

model LeaveType {
  id                String    @id @default(uuid())
  companyId         String    @map("company_id")
  name              String    @db.VarChar(100)
  code              String    @db.VarChar(20)
  daysPerYear       Decimal?  @map("default_days_per_year") @db.Decimal(5, 2)
  isActive          Boolean   @default(true) @map("is_active")
  
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  leaveBalances     LeaveBalance[]
  leaveApplications LeaveApplication[]

  @@unique([companyId, code])
  @@map("leave_types")
}

model LeaveBalance {
  id            String    @id @default(uuid())
  employeeId    String    @map("employee_id")
  leaveTypeId   String    @map("leave_type_id")
  year          Int
  
  openingBalance Decimal  @default(0) @map("opening_balance") @db.Decimal(5, 2)
  used          Decimal   @default(0) @db.Decimal(5, 2)
  credited      Decimal   @default(0) @db.Decimal(5, 2)
  
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, leaveTypeId, year])
  @@map("leave_balances")
}

model LeaveApplication {
  id            String    @id @default(uuid())
  employeeId    String    @map("employee_id")
  leaveTypeId   String    @map("leave_type_id")
  
  fromDate      DateTime  @map("from_date") @db.Date
  toDate        DateTime  @map("to_date") @db.Date
  totalDays     Decimal   @map("total_days") @db.Decimal(5, 2)
  reason        String    @db.Text
  status        String    @default("Pending") @db.VarChar(20)
  
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Restrict)

  @@index([employeeId])
  @@index([status])
  @@map("leave_applications")
}

// ============================================================================
// 7. PAYROLL RUNS
// ============================================================

model PayrollRun {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  payrollMonth    Int       @map("month")
  payrollYear     Int       @map("year")
  
  payPeriodStart  DateTime  @map("pay_period_start") @db.Date
  payPeriodEnd    DateTime  @map("pay_period_end") @db.Date
  status          String    @default("Draft") @db.VarChar(20)
  
  totalEmployees  Int?      @map("total_employees")
  totalGross      Decimal?  @map("total_gross") @db.Decimal(15, 2)
  totalDeductions Decimal?  @map("total_deductions") @db.Decimal(15, 2)
  totalNetPay     Decimal?  @map("total_net_pay") @db.Decimal(15, 2)
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")
  
  company         Company   @relation(fields: [companyId], references: [id])
  payrollDetails  PayrollDetail[]

  @@index([companyId])
  @@index([payrollMonth, payrollYear])
  @@map("payroll_runs")
}

model PayrollDetail {
  id              String    @id @default(uuid())
  payrollRunId    String    @map("payroll_run_id")
  employeeId      String    @map("employee_id")
  
  // Earnings
  basicSalary     Decimal?  @default(0) @map("basic_salary") @db.Decimal(12, 2)
  hra             Decimal?  @default(0) @db.Decimal(12, 2)
  specialAllowance Decimal? @default(0) @map("special_allowance") @db.Decimal(12, 2)
  otherAllowances Decimal?  @default(0) @map("other_allowances") @db.Decimal(12, 2)
  grossEarnings   Decimal?  @map("gross_earnings") @db.Decimal(12, 2)
  
  // Deductions
  pfEmployee      Decimal?  @default(0) @map("pf_employee") @db.Decimal(12, 2)
  esicEmployee    Decimal?  @default(0) @map("esic_employee") @db.Decimal(12, 2)
  pt              Decimal?  @default(0) @map("professional_tax") @db.Decimal(12, 2)
  tds             Decimal?  @default(0) @db.Decimal(12, 2)
  totalDeductions Decimal?  @map("total_deductions") @db.Decimal(12, 2)
  
  // Net
  netPay          Decimal?  @map("net_pay") @db.Decimal(12, 2)
  
  // Attendance Context
  payableDays     Decimal?  @map("payable_days") @db.Decimal(5, 2)
  
  payrollRun      PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee        Employee   @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  @@unique([payrollRunId, employeeId])
  @@map("payroll_details")
}

// ============================================================================
// 8. OTHERS (LOANS, COMPLIANCE, AUDIT)
// ============================================================

model Loan {
  id              String    @id @default(uuid())
  employeeId      String    @map("employee_id")
  companyId       String    @map("company_id")
  loanAmount      Decimal   @map("loan_amount") @db.Decimal(12, 2)
  status          String    @default("Pending") @db.VarChar(20)
  
  company         Company   @relation(fields: [companyId], references: [id])
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  repayments      LoanRepayment[]

  @@map("loans")
}

model LoanRepayment {
  id              String    @id @default(uuid())
  loanId          String    @map("loan_id")
  repaymentDate   DateTime  @map("repayment_date") @db.Date
  amount          Decimal   @db.Decimal(12, 2)
  
  loan            Loan      @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@map("loan_repayments")
}

model InvestmentDeclaration {
  id              String    @id @default(uuid())
  employeeId      String    @map("employee_id")
  financialYear   String    @map("financial_year") @db.VarChar(10)
  
  // Sections (Simplified for schema)
  total80C        Decimal?  @default(0) @map("total_80c") @db.Decimal(12, 2)
  total80D        Decimal?  @default(0) @map("total_80d") @db.Decimal(12, 2)
  hraRentPaid     Decimal?  @default(0) @map("hra_annual_rent") @db.Decimal(12, 2)
  
  status          String    @default("Draft") @db.VarChar(20)
  
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, financialYear])
  @@map("investment_declarations")
}

model ComplianceLog {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  complianceType  String    @map("compliance_type") @db.VarChar(50)
  periodMonth     Int       @map("period_month")
  periodYear      Int       @map("period_year")
  status          String    @default("Pending") @db.VarChar(20)
  
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("compliance_logs")
}

model AuditLog {
  id              String    @id @default(uuid())
  userId          String?   @map("user_id")
  action          String    @db.VarChar(100)
  entityType      String?   @map("entity_type")
  entityId        String?   @map("entity_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  
  user            User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  key         String   @map("setting_key") @db.VarChar(100)
  value       Json     @map("setting_value")
  
  company     Company? @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
  @@map("system_settings")
}
