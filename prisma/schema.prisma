// This is your Prisma schema file for UAE Payroll Management System

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION & USERS ====================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String
  image         String?
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  accounts      Account[]
  sessions      Session[]
  auditLogs     AuditLog[]
  leaveApprovals Leave[]  @relation("LeaveApprovals")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role          Role      @default(USER)
}

enum Role {
  SUPER_ADMIN
  ADMIN
  HR_MANAGER
  EMPLOYEE
  USER
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== ORGANIZATION & ENTITIES ====================

model Organization {
  id                String   @id @default(cuid())
  name              String
  tradeLicenseNo    String?  @unique
  taxRegistrationNo String?
  
  contactEmail      String?
  contactPhone      String?
  address           String?  @db.Text
  
  entities          Entity[]
  users             User[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Entity {
  id                String   @id @default(cuid())
  name              String

  
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  employees         Employee[]
  payrollRuns       PayrollRun[]
  shifts            Shift[]
  leavePolicies     LeavePolicy[]
  publicHolidays    PublicHoliday[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== EMPLOYEES ====================

model Employee {
  id                String   @id @default(cuid())
  employeeNumber    String   @unique
  
  // Personal Information
  firstName         String
  lastName          String
  nationality       String

  
  // Contact Information
  email             String?
  phone             String?
  
  // Employment Information
  entityId          String
  entity            Entity   @relation(fields: [entityId], references: [id])
  
  designation       String
  department        String?
  
  joinDate          DateTime
  endDate           DateTime?
  status            EmployeeStatus @default(ACTIVE)
  
  // Salary Information
  basicSalary       Decimal  @db.Decimal(10, 2)
  
  // Bank Information
  bankName          String?
  iban              String?
  bankAccountNo     String?
  
  // GPSSA Information

  
  // Relations
  contracts         EmploymentContract[]
  salaryElements    EmployeeSalaryElement[]
  payrollItems      PayrollItem[]
  payslips          Payslip[]
  leaves            Leave[]
  leaveBalances     LeaveBalance[]
  shifts            EmployeeShift[]
  attendances       Attendance[]
  overtimeRequests  OvertimeRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EmployeeStatus {
  ACTIVE
  TERMINATED
  SUSPENDED
  ON_LEAVE
}

model EmploymentContract {
  id             String   @id @default(cuid())
  
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id])
  
  contractType   ContractType
  startDate      DateTime
  endDate        DateTime?
  
  basicSalary    Decimal  @db.Decimal(10, 2)
  
  terms          String?  @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ContractType {
  UNLIMITED
  LIMITED
  PART_TIME
}

// ==================== SALARY ELEMENTS ====================

model SalaryElement {
  id             String   @id @default(cuid())

  name           String

  code           String   @unique

  type           ElementType
  category       ElementCategory

  isRecurring    Boolean  @default(true)  // Permanent or Temporary
  isTaxable      Boolean  @default(true)

  calculationMethod CalculationMethod @default(FIXED)

  // For percentage-based calculations
  percentageOf   String?  // "BASIC_SALARY" or other element code
  percentage     Decimal? @db.Decimal(5, 2)

  // For fixed amount
  defaultAmount  Decimal? @db.Decimal(10, 2)

  description    String?  @db.Text

  // Country-specific fields
  countryCode    String?  // "UAE", "INDIA", null for global
  isStatutory    Boolean  @default(false)  // Compliance-mandated element
  isSystemDefined Boolean @default(false)  // Cannot be deleted
  isActive       Boolean  @default(true)

  // Display and sorting
  displayOrder   Int      @default(0)
  showInPayslip  Boolean  @default(true)

  employees      EmployeeSalaryElement[]
  payrollItems   PayrollItemElement[]
  rules          PayrollElementRule[]
  complianceMappings PayrollElementComplianceMapping[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryCode])
  @@index([isActive])
  @@index([type, category])
}

// Advanced calculation rules for payroll elements
model PayrollElementRule {
  id             String   @id @default(cuid())

  elementId      String
  element        SalaryElement @relation(fields: [elementId], references: [id], onDelete: Cascade)

  ruleName       String
  ruleType       RuleType

  // Conditions (JSON structure)
  // Example: { "field": "basic", "operator": ">", "value": 15000 }
  conditions     Json?

  // Calculation formula (JSON structure)
  // Example: { "formula": "basic * 0.12", "max": 1800, "min": 0 }
  formula        Json

  // Applicability
  countryCode    String?
  state          String?   // For India PT calculation
  effectiveFrom  DateTime
  effectiveTo    DateTime?

  priority       Int      @default(0)  // Higher priority rules override lower
  isActive       Boolean  @default(true)

  description    String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([elementId])
  @@index([countryCode])
  @@index([isActive])
}

enum RuleType {
  STATUTORY_CALCULATION  // PF, ESIC, PT, GPSSA
  CONDITIONAL_FORMULA    // If-then-else logic
  TIERED_CALCULATION     // Slab-based (tax, PT)
  ATTENDANCE_BASED       // LOP, proration
  PERFORMANCE_BASED      // Bonus, incentives
  CUSTOM                 // JavaScript expression
}

// Compliance mapping for statutory elements
model PayrollElementComplianceMapping {
  id                    String   @id @default(cuid())

  elementId             String
  element               SalaryElement @relation(fields: [elementId], references: [id], onDelete: Cascade)

  countryCode           String
  complianceAuthority   String   // "PF", "ESIC", "PT", "TDS", "GPSSA", "WPS"

  reportingCode         String?  // Authority's code for this element
  reportingCategory     String?  // Category in compliance report

  calculationReference  String?  @db.Text  // Reference to law/circular

  // Wage ceiling and limits
  wageceiling           Decimal? @db.Decimal(10, 2)
  minAmount             Decimal? @db.Decimal(10, 2)
  maxAmount             Decimal? @db.Decimal(10, 2)

  // Applicability criteria (JSON)
  // Example: { "minSalary": 21000, "employeeType": "REGULAR" }
  applicabilityCriteria Json?

  effectiveFrom         DateTime
  effectiveTo           DateTime?

  isActive              Boolean  @default(true)

  notes                 String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([elementId, countryCode, complianceAuthority])
  @@index([countryCode])
  @@index([complianceAuthority])
}

enum ElementType {
  EARNING      // Allowances, bonuses
  DEDUCTION    // Loans, penalties
}

enum ElementCategory {
  // Earnings
  BASIC_SALARY
  HOUSING_ALLOWANCE
  TRANSPORT_ALLOWANCE
  FOOD_ALLOWANCE
  OTHER_ALLOWANCE
  BONUS
  COMMISSION
  OVERTIME
  INCENTIVE
  ARREARS

  // India-specific earnings
  HRA
  LTA
  SPECIAL_ALLOWANCE
  CONVEYANCE
  MEDICAL_ALLOWANCE
  EDUCATION_ALLOWANCE

  // Deductions
  LOAN_DEDUCTION
  ADVANCE_DEDUCTION
  PENALTY
  OTHER_DEDUCTION

  // Statutory deductions
  GPSSA_EMPLOYEE
  GPSSA_EMPLOYER
  PF_EMPLOYEE
  PF_EMPLOYER
  ESIC_EMPLOYEE
  ESIC_EMPLOYER
  PROFESSIONAL_TAX
  TDS
  LWF_EMPLOYEE
  LWF_EMPLOYER
}

enum CalculationMethod {
  FIXED           // Fixed amount
  PERCENTAGE      // Percentage of basic or other element
  PRORATED        // Prorated based on working days
}

model EmployeeSalaryElement {
  id             String   @id @default(cuid())
  
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  elementId      String
  element        SalaryElement @relation(fields: [elementId], references: [id])
  
  amount         Decimal  @db.Decimal(10, 2)
  effectiveFrom  DateTime
  effectiveTo    DateTime?
  
  isActive       Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([employeeId, elementId, effectiveFrom])
}

// ==================== PAYROLL PROCESSING ====================

model PayrollRun {
  id             String   @id @default(cuid())
  
  entityId       String
  entity         Entity   @relation(fields: [entityId], references: [id])
  
  payrollMonth   Int      // 1-12
  payrollYear    Int
  
  periodStart    DateTime
  periodEnd      DateTime
  
  status         PayrollStatus @default(DRAFT)
  
  totalGross     Decimal  @db.Decimal(12, 2) @default(0)
  totalDeductions Decimal @db.Decimal(12, 2) @default(0)
  totalNet       Decimal  @db.Decimal(12, 2) @default(0)
  
  employeeCount  Int      @default(0)
  
  calculatedAt   DateTime?
  approvedAt     DateTime?
  finalizedAt    DateTime?
  
  approvedBy     String?
  
  payrollItems   PayrollItem[]
  payslips       Payslip[]

  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([entityId, payrollMonth, payrollYear])
}

enum PayrollStatus {
  DRAFT
  CALCULATED
  APPROVED
  FINALIZED
  PAID
  CANCELLED
}

model PayrollItem {
  id             String   @id @default(cuid())
  
  payrollRunId   String
  payrollRun     PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id])
  
  // Calculated Amounts
  basicSalary    Decimal  @db.Decimal(10, 2)
  grossSalary    Decimal  @db.Decimal(10, 2)
  totalDeductions Decimal @db.Decimal(10, 2)
  netSalary      Decimal  @db.Decimal(10, 2)
  
  // GPSSA

  
  // Proration
  workingDays    Int      @default(30)
  actualDays     Int      @default(30)
  
  elements       PayrollItemElement[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([payrollRunId, employeeId])
}

model PayrollItemElement {
  id             String   @id @default(cuid())
  
  payrollItemId  String
  payrollItem    PayrollItem @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  
  elementId      String
  element        SalaryElement @relation(fields: [elementId], references: [id])
  
  amount         Decimal  @db.Decimal(10, 2)
  
  createdAt DateTime @default(now())
}

// ==================== PAYSLIPS ====================

model Payslip {
  id             String   @id @default(cuid())
  
  payrollRunId   String
  payrollRun     PayrollRun @relation(fields: [payrollRunId], references: [id])
  
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id])
  
  pdfUrl         String?  // Store PDF in cloud storage
  pdfContent     Bytes?   // Or store directly in DB
  
  generatedAt    DateTime @default(now())
  
  @@unique([payrollRunId, employeeId])
}



// ==================== AUDIT LOG ====================

model AuditLog {
  id             String   @id @default(cuid())

  userId         String
  user           User     @relation(fields: [userId], references: [id])

  action         String   // "PAYROLL_CALCULATED", "EMPLOYEE_ADDED", etc.
  entity         String   // "PayrollRun", "Employee", etc.
  entityId       String

  details        String?  @db.Text
  ipAddress      String?
  userAgent      String?

  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

// ==================== LEAVE MANAGEMENT ====================

model Leave {
  id              String   @id @default(cuid())

  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  leaveType       LeaveType
  startDate       DateTime
  endDate         DateTime
  numberOfDays    Decimal  @db.Decimal(5, 2)  // Support half-day leaves

  reason          String?  @db.Text
  status          LeaveStatus @default(PENDING)

  appliedDate     DateTime @default(now())
  approvedBy      String?
  approver        User?    @relation("LeaveApprovals", fields: [approvedBy], references: [id])
  approvedDate    DateTime?
  rejectionReason String?  @db.Text

  // Attachment support (medical certificate, etc.)
  attachmentUrl   String?

  // Workflow
  currentApprovalLevel Int @default(1)
  approvalChain   Json?    // Store approval workflow

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([leaveType])
}

enum LeaveType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  UNPAID
  EMERGENCY
  COMPASSIONATE
  STUDY
  HAJJ
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  WITHDRAWN
}

model LeaveBalance {
  id                    String   @id @default(cuid())

  employeeId            String
  employee              Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  year                  Int

  // Annual Leave
  annualLeaveEntitled   Decimal  @db.Decimal(5, 2) @default(30)
  annualLeaveTaken      Decimal  @db.Decimal(5, 2) @default(0)
  annualLeaveBalance    Decimal  @db.Decimal(5, 2) @default(30)
  annualLeaveCarryForward Decimal @db.Decimal(5, 2) @default(0)

  // Sick Leave
  sickLeaveEntitled     Decimal  @db.Decimal(5, 2) @default(15)
  sickLeaveTaken        Decimal  @db.Decimal(5, 2) @default(0)
  sickLeaveBalance      Decimal  @db.Decimal(5, 2) @default(15)

  // Unpaid Leave
  unpaidLeaveTaken      Decimal  @db.Decimal(5, 2) @default(0)

  // Other Leave Types
  maternityLeaveTaken   Decimal  @db.Decimal(5, 2) @default(0)
  paternityLeaveTaken   Decimal  @db.Decimal(5, 2) @default(0)
  emergencyLeaveTaken   Decimal  @db.Decimal(5, 2) @default(0)

  // Encashment tracking
  leaveEncashed         Decimal  @db.Decimal(5, 2) @default(0)
  encashmentAmount      Decimal  @db.Decimal(10, 2) @default(0)

  // Audit
  lastUpdated           DateTime @updatedAt
  createdAt             DateTime @default(now())

  @@unique([employeeId, year])
  @@index([employeeId])
  @@index([year])
}

model LeavePolicy {
  id                    String   @id @default(cuid())

  entityId              String?
  entity                Entity?  @relation(fields: [entityId], references: [id])

  policyName            String
  leaveType             LeaveType

  // Entitlement
  annualEntitlement     Decimal  @db.Decimal(5, 2)
  accrualMethod         AccrualMethod @default(YEARLY)
  accrualFrequency      Int      @default(12)  // months

  // Eligibility
  minimumServiceMonths  Int      @default(0)
  applicableGender      String?  // "MALE", "FEMALE", "ALL"

  // Carry Forward
  allowCarryForward     Boolean  @default(true)
  maxCarryForward       Decimal? @db.Decimal(5, 2)
  carryForwardExpiry    Int?     // months

  // Encashment
  allowEncashment       Boolean  @default(false)
  maxEncashmentDays     Decimal? @db.Decimal(5, 2)
  encashmentRate        Decimal? @db.Decimal(5, 2)  // multiplier of daily salary

  // Restrictions
  minDaysPerRequest     Decimal  @db.Decimal(5, 2) @default(0.5)
  maxDaysPerRequest     Decimal? @db.Decimal(5, 2)
  advanceNoticeDays     Int      @default(0)

  // Weekend/Holiday treatment
  includeWeekends       Boolean  @default(false)
  includeHolidays       Boolean  @default(false)

  isActive              Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([entityId])
  @@index([leaveType])
}

enum AccrualMethod {
  YEARLY        // All leaves at start of year
  MONTHLY       // Accrue monthly
  QUARTERLY     // Accrue quarterly
  ON_COMPLETION // After probation/tenure
}

// ==================== ATTENDANCE & SHIFT MANAGEMENT ====================

model Shift {
  id                  String   @id @default(cuid())

  entityId            String?
  entity              Entity?  @relation(fields: [entityId], references: [id])

  shiftCode           String   @unique
  shiftName           String

  // Timing
  startTime           String   // HH:mm format
  endTime             String   // HH:mm format
  breakDuration       Int      @default(0)  // minutes
  workingHours        Decimal  @db.Decimal(5, 2)

  // Grace period
  lateGracePeriod     Int      @default(15)  // minutes
  earlyOutGracePeriod Int      @default(15)  // minutes

  // Shift type
  isNightShift        Boolean  @default(false)
  nightShiftAllowance Decimal? @db.Decimal(10, 2)

  // Weekly off
  weeklyOffDays       Int[]    @default([5, 6])  // 0=Sunday, 6=Saturday

  // Overtime rules
  overtimeApplicable  Boolean  @default(true)
  overtimeMultiplier  Decimal  @db.Decimal(5, 2) @default(1.5)

  isActive            Boolean  @default(true)

  employeeShifts      EmployeeShift[]
  attendances         Attendance[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([entityId])
  @@index([isActive])
}

model EmployeeShift {
  id              String   @id @default(cuid())

  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  shiftId         String
  shift           Shift    @relation(fields: [shiftId], references: [id])

  effectiveFrom   DateTime
  effectiveTo     DateTime?

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([employeeId])
  @@index([shiftId])
  @@index([effectiveFrom])
}

model Attendance {
  id                String   @id @default(cuid())

  employeeId        String
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date              DateTime

  shiftId           String?
  shift             Shift?   @relation(fields: [shiftId], references: [id])

  // Check-in/out
  checkInTime       DateTime?
  checkOutTime      DateTime?
  checkInLocation   String?  // GPS coordinates or location name
  checkOutLocation  String?

  // Calculated hours
  workingHours      Decimal  @db.Decimal(5, 2) @default(0)

  // Status
  status            AttendanceStatus @default(PRESENT)
  attendanceType    AttendanceType @default(REGULAR)

  // Late/Early tracking
  lateBy            Int?     // minutes
  earlyOutBy        Int?     // minutes

  // Overtime
  overtimeHours     Decimal? @db.Decimal(5, 2)
  overtimeApproved  Boolean  @default(false)

  // Approval workflow
  requiresApproval  Boolean  @default(false)
  approvedBy        String?
  approvedDate      DateTime?

  // Notes
  remarks           String?  @db.Text

  // Manual entry
  isManualEntry     Boolean  @default(false)
  enteredBy         String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([attendanceType])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
  WEEKEND
  HOLIDAY
  HALF_DAY
  LATE
  EARLY_OUT
}

enum AttendanceType {
  REGULAR
  LATE
  EARLY_OUT
  OVERTIME
  WEEKEND_WORK
  HOLIDAY_WORK
}

model OvertimeRequest {
  id              String   @id @default(cuid())

  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  requestDate     DateTime @default(now())
  overtimeDate    DateTime

  startTime       String   // HH:mm
  endTime         String   // HH:mm
  hours           Decimal  @db.Decimal(5, 2)

  reason          String   @db.Text

  status          OvertimeStatus @default(PENDING)

  approvedBy      String?
  approvedDate    DateTime?
  rejectionReason String?  @db.Text

  // Calculation
  overtimeRate    Decimal? @db.Decimal(5, 2)  // multiplier (1.5x, 2x)
  amount          Decimal? @db.Decimal(10, 2)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([overtimeDate])
}

enum OvertimeStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model PublicHoliday {
  id              String   @id @default(cuid())

  entityId        String?
  entity          Entity?  @relation(fields: [entityId], references: [id])

  name            String
  nameArabic      String?
  date            DateTime
  year            Int

  isOptional      Boolean  @default(false)
  countryCode     String?  // "UAE", "INDIA", etc.

  description     String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([entityId])
  @@index([date])
  @@index([year])
}

// ============================================================================
// MULTI-COUNTRY SUPPORT
// ============================================================================

model Country {
  id              String   @id @default(cuid())
  code            String   @unique  // "UAE", "INDIA", "SAU", etc.
  name            String
  currency        String
  currencySymbol  String
  isActive        Boolean  @default(true)

  // Configuration
  financialYearStart Int   @default(1)  // Month (1-12)
  weekendDays     Int[]    @default([5, 6])  // Friday, Saturday for UAE

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// INDIA PAYROLL EXTENSION
// ============================================================================

// India-specific employee information
model EmployeeIndia {
  id              String   @id @default(cuid())

  // Link to base employee (optional - can be standalone)
  baseEmployeeId  String?  @unique

  // Employee Info
  employeeCode    String   @unique
  firstName       String
  lastName        String
  email           String?
  phone           String?
  dateOfBirth     DateTime?
  gender          String?
  dateOfJoining   DateTime
  department      String?
  designation     String?
  status          IndiaEmployeeStatus @default(ACTIVE)

  // Statutory IDs
  pan             String   @unique  // Permanent Account Number
  aadhaar         String?  @unique  // 12-digit Aadhaar
  uan             String?           // Universal Account Number (PF)
  esicNumber      String?           // ESIC Number (17 digits)

  // Bank Details
  bankName        String?
  bankAccount     String
  ifscCode        String

  // Location (for PT calculation)
  state           String
  city            String?
  cityType        IndiaCityType @default(NON_METRO)

  // Salary Structure
  basic           Decimal  @db.Decimal(10, 2)
  hra             Decimal  @db.Decimal(10, 2) @default(0)
  lta             Decimal  @db.Decimal(10, 2) @default(0)
  specialAllowance Decimal @db.Decimal(10, 2) @default(0)
  conveyance      Decimal  @db.Decimal(10, 2) @default(0)
  medicalAllowance Decimal @db.Decimal(10, 2) @default(0)
  otherAllowances Json?
  ctc             Decimal? @db.Decimal(12, 2)

  // Statutory Applicability
  pfApplicable    Boolean  @default(true)
  esicApplicable  Boolean  @default(false)
  ptApplicable    Boolean  @default(true)
  lwfApplicable   Boolean  @default(false)

  // Tax Information
  taxRegime       IndiaTaxRegime @default(NEW)

  // Relations
  taxDeclarations IndiaTaxDeclaration[]
  payrollRuns     PayrollRunIndia[]
  payslips        PayslipIndia[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pan])
  @@index([state])
  @@index([status])
}

enum IndiaEmployeeStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  ON_NOTICE
}

enum IndiaCityType {
  METRO       // Delhi, Mumbai, Chennai, Kolkata
  NON_METRO
}

enum IndiaTaxRegime {
  OLD
  NEW
}

// India Tax Declarations (Section 80C, 80D, etc.)
model IndiaTaxDeclaration {
  id              String   @id @default(cuid())

  employeeId      String
  employee        EmployeeIndia @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  financialYear   String   // "2024-25"

  // Section 80C (max 1.5L)
  section80C_PPF          Decimal @db.Decimal(10, 2) @default(0)
  section80C_ELSS         Decimal @db.Decimal(10, 2) @default(0)
  section80C_LIC          Decimal @db.Decimal(10, 2) @default(0)
  section80C_NSC          Decimal @db.Decimal(10, 2) @default(0)
  section80C_TuitionFees  Decimal @db.Decimal(10, 2) @default(0)
  section80C_HomeLoan     Decimal @db.Decimal(10, 2) @default(0)
  section80C_Others       Decimal @db.Decimal(10, 2) @default(0)

  // Section 80D (Medical Insurance)
  section80D_Self         Decimal @db.Decimal(10, 2) @default(0)
  section80D_Parents      Decimal @db.Decimal(10, 2) @default(0)
  parentsAreSenior        Boolean @default(false)

  // Other Sections
  section80E              Decimal @db.Decimal(10, 2) @default(0)  // Education Loan
  section80G              Decimal @db.Decimal(10, 2) @default(0)  // Donations
  section24               Decimal @db.Decimal(10, 2) @default(0)  // Home Loan Interest

  // HRA Details
  monthlyRent             Decimal @db.Decimal(10, 2) @default(0)
  landlordPan             String?

  status                  DeclarationStatus @default(DRAFT)
  submittedAt             DateTime?
  verifiedAt              DateTime?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([employeeId, financialYear])
}

enum DeclarationStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}

// India Payroll Runs
model PayrollRunIndia {
  id              String   @id @default(cuid())

  // Period
  payPeriodMonth  Int      // 1-12
  payPeriodYear   Int
  financialYear   String   // "2024-25"

  // Employee
  employeeId      String
  employee        EmployeeIndia @relation(fields: [employeeId], references: [id])

  // Earnings
  basic           Decimal  @db.Decimal(10, 2)
  hra             Decimal  @db.Decimal(10, 2) @default(0)
  lta             Decimal  @db.Decimal(10, 2) @default(0)
  specialAllowance Decimal @db.Decimal(10, 2) @default(0)
  conveyance      Decimal  @db.Decimal(10, 2) @default(0)
  medicalAllowance Decimal @db.Decimal(10, 2) @default(0)
  otherEarnings   Json?
  grossSalary     Decimal  @db.Decimal(10, 2)

  // Statutory Deductions
  pfEmployee      Decimal  @db.Decimal(10, 2) @default(0)
  esicEmployee    Decimal  @db.Decimal(10, 2) @default(0)
  professionalTax Decimal  @db.Decimal(10, 2) @default(0)
  tds             Decimal  @db.Decimal(10, 2) @default(0)
  lwf             Decimal  @db.Decimal(10, 2) @default(0)
  otherDeductions Json?
  totalDeductions Decimal  @db.Decimal(10, 2)

  // Net Pay
  netSalary       Decimal  @db.Decimal(10, 2)

  // Employer Contributions
  pfEmployer      Decimal  @db.Decimal(10, 2) @default(0)
  esicEmployer    Decimal  @db.Decimal(10, 2) @default(0)
  pfAdminCharges  Decimal  @db.Decimal(10, 2) @default(0)

  // Working Days
  workingDays     Int      @default(26)
  presentDays     Int      @default(26)
  lopDays         Int      @default(0)

  // Status
  status          IndiaPayrollStatus @default(DRAFT)
  processedAt     DateTime?
  approvedAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([employeeId, payPeriodMonth, payPeriodYear])
  @@index([financialYear])
  @@index([status])
}

enum IndiaPayrollStatus {
  DRAFT
  CALCULATED
  APPROVED
  FINALIZED
  PAID
}

// India Payslips
model PayslipIndia {
  id              String   @id @default(cuid())

  employeeId      String
  employee        EmployeeIndia @relation(fields: [employeeId], references: [id])

  payPeriodMonth  Int
  payPeriodYear   Int
  financialYear   String

  // Amounts
  grossSalary     Decimal  @db.Decimal(10, 2)
  totalDeductions Decimal  @db.Decimal(10, 2)
  netSalary       Decimal  @db.Decimal(10, 2)

  // Full breakdown stored as JSON
  earningsBreakdown  Json
  deductionsBreakdown Json
  employerContributions Json?

  // YTD
  ytdGross        Decimal? @db.Decimal(12, 2)
  ytdDeductions   Decimal? @db.Decimal(12, 2)
  ytdNetPay       Decimal? @db.Decimal(12, 2)
  ytdTDS          Decimal? @db.Decimal(12, 2)

  // PDF
  pdfUrl          String?

  generatedAt     DateTime @default(now())

  @@unique([employeeId, payPeriodMonth, payPeriodYear])
}

// India Compliance Reports
model IndiaComplianceReport {
  id              String   @id @default(cuid())

  type            IndiaComplianceType

  // Period
  month           Int?
  quarter         Int?     // 1-4 for quarterly reports
  financialYear   String

  // Data
  data            Json

  // Status
  status          ComplianceReportStatus @default(PENDING)
  generatedAt     DateTime?
  submittedAt     DateTime?
  acknowledgedAt  DateTime?

  // Reference Numbers
  challanNo       String?
  receiptNo       String?

  // File
  fileUrl         String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type, financialYear])
}

enum IndiaComplianceType {
  PF_ECR          // Monthly PF ECR
  ESIC_MONTHLY    // Monthly ESIC
  PT_CHALLAN      // Professional Tax Challan
  FORM_24Q        // Quarterly TDS Statement
  FORM_16         // Annual TDS Certificate
  FORM_12BA       // Annual Perquisites Statement
}

enum ComplianceReportStatus {
  PENDING
  GENERATED
  SUBMITTED
  ACKNOWLEDGED
  REJECTED
}
