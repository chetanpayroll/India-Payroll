// This is your Prisma schema file for UAE Payroll Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION & USERS ====================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String
  image         String?
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  accounts      Account[]
  sessions      Session[]
  auditLogs     AuditLog[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== ORGANIZATION & ENTITIES ====================

model Organization {
  id                String   @id @default(cuid())
  name              String
  tradeLicenseNo    String?  @unique
  taxRegistrationNo String?
  
  contactEmail      String?
  contactPhone      String?
  address           String?  @db.Text
  
  entities          Entity[]
  users             User[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Entity {
  id                String   @id @default(cuid())
  name              String
  establishmentNo   String?  @unique  // UAE Establishment Card Number
  laborCardNo       String?
  wpsRegistrationNo String?  // WPS Registration Number
  
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  employees         Employee[]
  payrollRuns       PayrollRun[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== EMPLOYEES ====================

model Employee {
  id                String   @id @default(cuid())
  employeeNumber    String   @unique
  
  // Personal Information
  firstName         String
  lastName          String
  nationality       String
  emiratesIdNo      String?  @unique
  passportNo        String?
  
  // Contact Information
  email             String?
  phone             String?
  
  // Employment Information
  entityId          String
  entity            Entity   @relation(fields: [entityId], references: [id])
  
  designation       String
  department        String?
  
  joinDate          DateTime
  endDate           DateTime?
  status            EmployeeStatus @default(ACTIVE)
  
  // Salary Information
  basicSalary       Decimal  @db.Decimal(10, 2)
  
  // Bank Information
  bankName          String?
  iban              String?
  bankAccountNo     String?
  
  // GPSSA Information
  isEmirati         Boolean  @default(false)
  gpssaNumber       String?
  
  // Relations
  contracts         EmploymentContract[]
  salaryElements    EmployeeSalaryElement[]
  payrollItems      PayrollItem[]
  payslips          Payslip[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EmployeeStatus {
  ACTIVE
  TERMINATED
  SUSPENDED
  ON_LEAVE
}

model EmploymentContract {
  id             String   @id @default(cuid())
  
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id])
  
  contractType   ContractType
  startDate      DateTime
  endDate        DateTime?
  
  basicSalary    Decimal  @db.Decimal(10, 2)
  
  terms          String?  @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ContractType {
  UNLIMITED
  LIMITED
  PART_TIME
}

// ==================== SALARY ELEMENTS ====================

model SalaryElement {
  id             String   @id @default(cuid())
  
  name           String
  nameArabic     String?
  code           String   @unique
  
  type           ElementType
  category       ElementCategory
  
  isRecurring    Boolean  @default(true)  // Permanent or Temporary
  isTaxable      Boolean  @default(true)
  
  calculationMethod CalculationMethod @default(FIXED)
  
  // For percentage-based calculations
  percentageOf   String?  // "BASIC_SALARY" or other element code
  percentage     Decimal? @db.Decimal(5, 2)
  
  // For fixed amount
  defaultAmount  Decimal? @db.Decimal(10, 2)
  
  description    String?  @db.Text
  
  employees      EmployeeSalaryElement[]
  payrollItems   PayrollItemElement[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ElementType {
  EARNING      // Allowances, bonuses
  DEDUCTION    // Loans, penalties
}

enum ElementCategory {
  BASIC_SALARY
  HOUSING_ALLOWANCE
  TRANSPORT_ALLOWANCE
  FOOD_ALLOWANCE
  OTHER_ALLOWANCE
  BONUS
  COMMISSION
  OVERTIME
  LOAN_DEDUCTION
  ADVANCE_DEDUCTION
  PENALTY
  OTHER_DEDUCTION
  GPSSA_EMPLOYEE
  GPSSA_EMPLOYER
}

enum CalculationMethod {
  FIXED           // Fixed amount
  PERCENTAGE      // Percentage of basic or other element
  PRORATED        // Prorated based on working days
}

model EmployeeSalaryElement {
  id             String   @id @default(cuid())
  
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  elementId      String
  element        SalaryElement @relation(fields: [elementId], references: [id])
  
  amount         Decimal  @db.Decimal(10, 2)
  effectiveFrom  DateTime
  effectiveTo    DateTime?
  
  isActive       Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([employeeId, elementId, effectiveFrom])
}

// ==================== PAYROLL PROCESSING ====================

model PayrollRun {
  id             String   @id @default(cuid())
  
  entityId       String
  entity         Entity   @relation(fields: [entityId], references: [id])
  
  payrollMonth   Int      // 1-12
  payrollYear    Int
  
  periodStart    DateTime
  periodEnd      DateTime
  
  status         PayrollStatus @default(DRAFT)
  
  totalGross     Decimal  @db.Decimal(12, 2) @default(0)
  totalDeductions Decimal @db.Decimal(12, 2) @default(0)
  totalNet       Decimal  @db.Decimal(12, 2) @default(0)
  
  employeeCount  Int      @default(0)
  
  calculatedAt   DateTime?
  approvedAt     DateTime?
  finalizedAt    DateTime?
  
  approvedBy     String?
  
  payrollItems   PayrollItem[]
  payslips       Payslip[]
  wpsFiles       WPSFile[]
  gpssaReports   GPSSAReport[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([entityId, payrollMonth, payrollYear])
}

enum PayrollStatus {
  DRAFT
  CALCULATED
  APPROVED
  FINALIZED
  PAID
  CANCELLED
}

model PayrollItem {
  id             String   @id @default(cuid())
  
  payrollRunId   String
  payrollRun     PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id])
  
  // Calculated Amounts
  basicSalary    Decimal  @db.Decimal(10, 2)
  grossSalary    Decimal  @db.Decimal(10, 2)
  totalDeductions Decimal @db.Decimal(10, 2)
  netSalary      Decimal  @db.Decimal(10, 2)
  
  // GPSSA
  gpssaEmployee  Decimal  @db.Decimal(10, 2) @default(0)
  gpssaEmployer  Decimal  @db.Decimal(10, 2) @default(0)
  
  // Proration
  workingDays    Int      @default(30)
  actualDays     Int      @default(30)
  
  elements       PayrollItemElement[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([payrollRunId, employeeId])
}

model PayrollItemElement {
  id             String   @id @default(cuid())
  
  payrollItemId  String
  payrollItem    PayrollItem @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  
  elementId      String
  element        SalaryElement @relation(fields: [elementId], references: [id])
  
  amount         Decimal  @db.Decimal(10, 2)
  
  createdAt DateTime @default(now())
}

// ==================== PAYSLIPS ====================

model Payslip {
  id             String   @id @default(cuid())
  
  payrollRunId   String
  payrollRun     PayrollRun @relation(fields: [payrollRunId], references: [id])
  
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id])
  
  pdfUrl         String?  // Store PDF in cloud storage
  pdfContent     Bytes?   // Or store directly in DB
  
  generatedAt    DateTime @default(now())
  
  @@unique([payrollRunId, employeeId])
}

// ==================== WPS & GPSSA COMPLIANCE ====================

model WPSFile {
  id             String   @id @default(cuid())
  
  payrollRunId   String
  payrollRun     PayrollRun @relation(fields: [payrollRunId], references: [id])
  
  fileName       String
  fileContent    String   @db.Text  // SIF file content
  
  recordCount    Int
  totalAmount    Decimal  @db.Decimal(12, 2)
  
  generatedAt    DateTime @default(now())
}

model GPSSAReport {
  id             String   @id @default(cuid())
  
  payrollRunId   String
  payrollRun     PayrollRun @relation(fields: [payrollRunId], references: [id])
  
  reportType     String   // "MONTHLY_CONTRIBUTION"
  
  totalEmployees Int
  totalEmployeeContribution Decimal @db.Decimal(12, 2)
  totalEmployerContribution Decimal @db.Decimal(12, 2)
  
  fileContent    String?  @db.Text
  
  generatedAt    DateTime @default(now())
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id             String   @id @default(cuid())

  userId         String
  user           User     @relation(fields: [userId], references: [id])

  action         String   // "PAYROLL_CALCULATED", "EMPLOYEE_ADDED", etc.
  entity         String   // "PayrollRun", "Employee", etc.
  entityId       String

  details        String?  @db.Text
  ipAddress      String?
  userAgent      String?

  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

// ============================================================================
// MULTI-COUNTRY SUPPORT
// ============================================================================

model Country {
  id              String   @id @default(cuid())
  code            String   @unique  // "UAE", "INDIA", "SAU", etc.
  name            String
  currency        String
  currencySymbol  String
  isActive        Boolean  @default(true)

  // Configuration
  financialYearStart Int   @default(1)  // Month (1-12)
  weekendDays     Int[]    @default([5, 6])  // Friday, Saturday for UAE

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// INDIA PAYROLL EXTENSION
// ============================================================================

// India-specific employee information
model EmployeeIndia {
  id              String   @id @default(cuid())

  // Link to base employee (optional - can be standalone)
  baseEmployeeId  String?  @unique

  // Employee Info
  employeeCode    String   @unique
  firstName       String
  lastName        String
  email           String?
  phone           String?
  dateOfBirth     DateTime?
  gender          String?
  dateOfJoining   DateTime
  department      String?
  designation     String?
  status          IndiaEmployeeStatus @default(ACTIVE)

  // Statutory IDs
  pan             String   @unique  // Permanent Account Number
  aadhaar         String?  @unique  // 12-digit Aadhaar
  uan             String?           // Universal Account Number (PF)
  esicNumber      String?           // ESIC Number (17 digits)

  // Bank Details
  bankName        String?
  bankAccount     String
  ifscCode        String

  // Location (for PT calculation)
  state           String
  city            String?
  cityType        IndiaCityType @default(NON_METRO)

  // Salary Structure
  basic           Decimal  @db.Decimal(10, 2)
  hra             Decimal  @db.Decimal(10, 2) @default(0)
  lta             Decimal  @db.Decimal(10, 2) @default(0)
  specialAllowance Decimal @db.Decimal(10, 2) @default(0)
  conveyance      Decimal  @db.Decimal(10, 2) @default(0)
  medicalAllowance Decimal @db.Decimal(10, 2) @default(0)
  otherAllowances Json?
  ctc             Decimal? @db.Decimal(12, 2)

  // Statutory Applicability
  pfApplicable    Boolean  @default(true)
  esicApplicable  Boolean  @default(false)
  ptApplicable    Boolean  @default(true)
  lwfApplicable   Boolean  @default(false)

  // Tax Information
  taxRegime       IndiaTaxRegime @default(NEW)

  // Relations
  taxDeclarations IndiaTaxDeclaration[]
  payrollRuns     PayrollRunIndia[]
  payslips        PayslipIndia[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pan])
  @@index([state])
  @@index([status])
}

enum IndiaEmployeeStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  ON_NOTICE
}

enum IndiaCityType {
  METRO       // Delhi, Mumbai, Chennai, Kolkata
  NON_METRO
}

enum IndiaTaxRegime {
  OLD
  NEW
}

// India Tax Declarations (Section 80C, 80D, etc.)
model IndiaTaxDeclaration {
  id              String   @id @default(cuid())

  employeeId      String
  employee        EmployeeIndia @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  financialYear   String   // "2024-25"

  // Section 80C (max 1.5L)
  section80C_PPF          Decimal @db.Decimal(10, 2) @default(0)
  section80C_ELSS         Decimal @db.Decimal(10, 2) @default(0)
  section80C_LIC          Decimal @db.Decimal(10, 2) @default(0)
  section80C_NSC          Decimal @db.Decimal(10, 2) @default(0)
  section80C_TuitionFees  Decimal @db.Decimal(10, 2) @default(0)
  section80C_HomeLoan     Decimal @db.Decimal(10, 2) @default(0)
  section80C_Others       Decimal @db.Decimal(10, 2) @default(0)

  // Section 80D (Medical Insurance)
  section80D_Self         Decimal @db.Decimal(10, 2) @default(0)
  section80D_Parents      Decimal @db.Decimal(10, 2) @default(0)
  parentsAreSenior        Boolean @default(false)

  // Other Sections
  section80E              Decimal @db.Decimal(10, 2) @default(0)  // Education Loan
  section80G              Decimal @db.Decimal(10, 2) @default(0)  // Donations
  section24               Decimal @db.Decimal(10, 2) @default(0)  // Home Loan Interest

  // HRA Details
  monthlyRent             Decimal @db.Decimal(10, 2) @default(0)
  landlordPan             String?

  status                  DeclarationStatus @default(DRAFT)
  submittedAt             DateTime?
  verifiedAt              DateTime?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([employeeId, financialYear])
}

enum DeclarationStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}

// India Payroll Runs
model PayrollRunIndia {
  id              String   @id @default(cuid())

  // Period
  payPeriodMonth  Int      // 1-12
  payPeriodYear   Int
  financialYear   String   // "2024-25"

  // Employee
  employeeId      String
  employee        EmployeeIndia @relation(fields: [employeeId], references: [id])

  // Earnings
  basic           Decimal  @db.Decimal(10, 2)
  hra             Decimal  @db.Decimal(10, 2) @default(0)
  lta             Decimal  @db.Decimal(10, 2) @default(0)
  specialAllowance Decimal @db.Decimal(10, 2) @default(0)
  conveyance      Decimal  @db.Decimal(10, 2) @default(0)
  medicalAllowance Decimal @db.Decimal(10, 2) @default(0)
  otherEarnings   Json?
  grossSalary     Decimal  @db.Decimal(10, 2)

  // Statutory Deductions
  pfEmployee      Decimal  @db.Decimal(10, 2) @default(0)
  esicEmployee    Decimal  @db.Decimal(10, 2) @default(0)
  professionalTax Decimal  @db.Decimal(10, 2) @default(0)
  tds             Decimal  @db.Decimal(10, 2) @default(0)
  lwf             Decimal  @db.Decimal(10, 2) @default(0)
  otherDeductions Json?
  totalDeductions Decimal  @db.Decimal(10, 2)

  // Net Pay
  netSalary       Decimal  @db.Decimal(10, 2)

  // Employer Contributions
  pfEmployer      Decimal  @db.Decimal(10, 2) @default(0)
  esicEmployer    Decimal  @db.Decimal(10, 2) @default(0)
  pfAdminCharges  Decimal  @db.Decimal(10, 2) @default(0)

  // Working Days
  workingDays     Int      @default(26)
  presentDays     Int      @default(26)
  lopDays         Int      @default(0)

  // Status
  status          IndiaPayrollStatus @default(DRAFT)
  processedAt     DateTime?
  approvedAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([employeeId, payPeriodMonth, payPeriodYear])
  @@index([financialYear])
  @@index([status])
}

enum IndiaPayrollStatus {
  DRAFT
  CALCULATED
  APPROVED
  FINALIZED
  PAID
}

// India Payslips
model PayslipIndia {
  id              String   @id @default(cuid())

  employeeId      String
  employee        EmployeeIndia @relation(fields: [employeeId], references: [id])

  payPeriodMonth  Int
  payPeriodYear   Int
  financialYear   String

  // Amounts
  grossSalary     Decimal  @db.Decimal(10, 2)
  totalDeductions Decimal  @db.Decimal(10, 2)
  netSalary       Decimal  @db.Decimal(10, 2)

  // Full breakdown stored as JSON
  earningsBreakdown  Json
  deductionsBreakdown Json
  employerContributions Json?

  // YTD
  ytdGross        Decimal? @db.Decimal(12, 2)
  ytdDeductions   Decimal? @db.Decimal(12, 2)
  ytdNetPay       Decimal? @db.Decimal(12, 2)
  ytdTDS          Decimal? @db.Decimal(12, 2)

  // PDF
  pdfUrl          String?

  generatedAt     DateTime @default(now())

  @@unique([employeeId, payPeriodMonth, payPeriodYear])
}

// India Compliance Reports
model IndiaComplianceReport {
  id              String   @id @default(cuid())

  type            IndiaComplianceType

  // Period
  month           Int?
  quarter         Int?     // 1-4 for quarterly reports
  financialYear   String

  // Data
  data            Json

  // Status
  status          ComplianceReportStatus @default(PENDING)
  generatedAt     DateTime?
  submittedAt     DateTime?
  acknowledgedAt  DateTime?

  // Reference Numbers
  challanNo       String?
  receiptNo       String?

  // File
  fileUrl         String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type, financialYear])
}

enum IndiaComplianceType {
  PF_ECR          // Monthly PF ECR
  ESIC_MONTHLY    // Monthly ESIC
  PT_CHALLAN      // Professional Tax Challan
  FORM_24Q        // Quarterly TDS Statement
  FORM_16         // Annual TDS Certificate
  FORM_12BA       // Annual Perquisites Statement
}

enum ComplianceReportStatus {
  PENDING
  GENERATED
  SUBMITTED
  ACKNOWLEDGED
  REJECTED
}
