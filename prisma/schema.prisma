// GMP Payroll - Enterprise Scale Schema
// Version: 2.0 (Production Ready)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 1. AUTHENTICATION & USER MANAGEMENT
// ============================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String    @map("password_hash")
  name          String
  role          String    @default("employee") // super_admin, admin, manager, hr, finance, employee
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")
  createdBy     String?   @map("created_by") // UUID
  updatedBy     String?   @map("updated_by") // UUID

  sessions      Session[]
  companyUsers  CompanyUser[]
  auditLogs     AuditLog[]
  
  // Relations for tracking
  createdCompanies Company[] @relation("CreatedBy")
  updatedCompanies Company[] @relation("UpdatedBy")

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================================================
// 2. COMPANY MANAGEMENT (MULTI-TENANT)
// ============================================================

model Company {
  id                    String   @id @default(uuid())
  name                  String
  legalName             String   @map("legal_name")
  registrationNumber    String?  @map("registration_number")
  
  // Indian Tax Identifiers
  pan                   String   @unique
  tan                   String?
  gstin                 String?
  
  // Statutory Registrations
  pfRegistrationNumber  String?  @map("pf_registration_number")
  pfEstablishmentId     String?  @map("pf_establishment_id")
  esicRegistrationNumber String? @map("esic_registration_number")
  ptRegistrationNumber  String?  @map("pt_registration_number")
  lwfRegistrationNumber String?  @map("lwf_registration_number")
  
  // Address
  addressLine1          String?  @map("address_line1")
  addressLine2          String?  @map("address_line2")
  city                  String?
  state                 String?
  postalCode            String?  @map("postal_code")
  country               String   @default("India")
  
  // Contact
  phone                 String?
  email                 String?
  website               String?
  
  // Bank
  bankName              String?  @map("bank_name")
  bankAccountNumber     String?  @map("bank_account_number")
  bankIfsc              String?  @map("bank_ifsc")
  bankBranch            String?  @map("bank_branch")
  
  // Meta
  industry              String?
  employeeCount         Int      @default(0) @map("employee_count")
  financialYearStart    Int      @default(4) @map("financial_year_start") // April
  isActive              Boolean  @default(true) @map("is_active")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at")
  createdById           String?  @map("created_by")
  updatedById           String?  @map("updated_by")

  createdBy             User?    @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy             User?    @relation("UpdatedBy", fields: [updatedById], references: [id])

  employees             Employee[]
  payrollRuns           PayrollRun[]
  attendanceRecords     AttendanceRecord[]
  leaveTypes            LeaveType[]
  complianceLogs        ComplianceLog[]
  companyUsers          CompanyUser[]
  loans                 Loan[]
  systemSettings        SystemSetting[]

  @@index([pan])
  @@index([isActive])
  @@map("companies")
}

model CompanyUser {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  userId      String   @map("user_id")
  role        String   // admin, manager, hr, finance
  permissions String?  // Granular permissions (JSON stored as string for SQLite compatibility)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@map("company_users")
}

// ============================================================================
// 3. EMPLOYEE MASTER DATA
// ============================================================

model Employee {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")
  
  // Basic Info
  employeeCode          String    @map("employee_code")
  title                 String?
  firstName             String    @map("first_name")
  middleName            String?   @map("middle_name")
  lastName              String    @map("last_name")
  
  // Personal
  dateOfBirth           DateTime? @map("date_of_birth")
  gender                String?
  maritalStatus         String?   @map("marital_status")
  bloodGroup            String?   @map("blood_group")
  
  // Contact
  email                 String?
  personalEmail         String?   @map("personal_email")
  mobile                String?
  currentAddressLine1   String?   @map("current_address_line1")
  currentCity           String?   @map("current_city")
  
  // Employment
  dateOfJoining         DateTime  @map("date_of_joining")
  dateOfLeaving         DateTime? @map("date_of_leaving")
  employmentType        String    @default("Permanent") @map("employment_type")
  status                String    @default("Active")
  department            String?
  designation           String?
  location              String?   @map("work_location")
  reportingManagerId    String?   @map("reporting_manager_id")
  
  // Statutory
  pan                   String?
  aadhaar               String?
  uan                   String?
  esicIpNumber          String?   @map("esic_ip_number")
  
  // Bank
  bankAccountNumber     String?   @map("bank_account_number")
  bankIfsc              String?   @map("bank_ifsc")
  bankName              String?   @map("bank_name")
  
  // Metadata
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  company               Company   @relation(fields: [companyId], references: [id])
  manager               Employee? @relation("ReportingManager", fields: [reportingManagerId], references: [id])
  subordinates          Employee[] @relation("ReportingManager")
  
  salaryStructure       SalaryStructure?
  attendanceRecords     AttendanceRecord[]
  leaveBalances         LeaveBalance[]
  leaveApplications     LeaveApplication[]
  investmentDeclarations InvestmentDeclaration[]
  loans                 Loan[]
  payrollDetails        PayrollDetail[]

  @@unique([companyId, employeeCode])
  @@index([companyId])
  @@index([status])
  @@index([department])
  @@map("employees")
}

// ============================================================================
// 4. SALARY STRUCTURE
// ============================================================

model SalaryStructure {
  id                String    @id @default(uuid())
  employeeId        String    @unique @map("employee_id")
  effectiveFrom     DateTime  @map("effective_from")
  effectiveTo       DateTime? @map("effective_to")
  
  // Components
  basicSalary       Float   @map("basic_salary")
  hra               Float?  @default(0)
  specialAllowance  Float?  @default(0) @map("special_allowance")
  transportAllowance Float? @default(0) @map("transport_allowance")
  medicalAllowance  Float?  @default(0) @map("medical_allowance")
  lta               Float?  @default(0)
  otherAllowances   Float?  @default(0) @map("other_allowances")
  
  // Calculated (can be computed, but stored for ease)
  // grossSalary omitted, calculated at runtime or app level

  // Applicability
  pfApplicable      Boolean   @default(true) @map("pf_applicable")
  esicApplicable    Boolean   @default(false) @map("esic_applicable")
  ptApplicable      Boolean   @default(true) @map("pt_applicable")
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  employee          Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([effectiveFrom])
  @@map("salary_structures")
}

// ============================================================================
// 5. ATTENDANCE
// ============================================================

model AttendanceRecord {
  id                String    @id @default(uuid())
  employeeId        String    @map("employee_id")
  companyId         String    @map("company_id")
  attendanceDate    DateTime  @map("attendance_date")
  
  status            String    // Present, Absent, Half Day, Leave
  checkInTime       DateTime? @map("check_in_time")
  checkOutTime      DateTime? @map("check_out_time")
  totalHours        Float?  @map("total_hours")
  
  overtimeHours     Float?  @default(0) @map("overtime_hours")
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  employee          Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  company           Company   @relation(fields: [companyId], references: [id])

  @@unique([employeeId, attendanceDate])
  @@index([companyId, attendanceDate])
  @@map("attendance_records")
}

// ============================================================================
// 6. LEAVES
// ============================================================

model LeaveType {
  id                String    @id @default(uuid())
  companyId         String    @map("company_id")
  name              String
  code              String
  daysPerYear       Float?  @map("default_days_per_year")
  isActive          Boolean   @default(true) @map("is_active")
  
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  leaveBalances     LeaveBalance[]
  leaveApplications LeaveApplication[]

  @@unique([companyId, code])
  @@map("leave_types")
}

model LeaveBalance {
  id            String    @id @default(uuid())
  employeeId    String    @map("employee_id")
  leaveTypeId   String    @map("leave_type_id")
  year          Int
  
  openingBalance Float  @default(0) @map("opening_balance")
  used          Float   @default(0)
  credited      Float   @default(0)
  
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, leaveTypeId, year])
  @@map("leave_balances")
}

model LeaveApplication {
  id            String    @id @default(uuid())
  employeeId    String    @map("employee_id")
  leaveTypeId   String    @map("leave_type_id")
  
  fromDate      DateTime  @map("from_date")
  toDate        DateTime  @map("to_date")
  totalDays     Float   @map("total_days")
  reason        String
  status        String    @default("Pending")
  
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Restrict)

  @@index([employeeId])
  @@index([status])
  @@map("leave_applications")
}

// ============================================================================
// 7. PAYROLL RUNS
// ============================================================

model PayrollRun {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  payrollMonth    Int       @map("month")
  payrollYear     Int       @map("year")
  
  payPeriodStart  DateTime  @map("pay_period_start")
  payPeriodEnd    DateTime  @map("pay_period_end")
  status          String    @default("Draft")
  
  totalEmployees  Int?      @map("total_employees")
  totalGross      Float?  @map("total_gross")
  totalDeductions Float?  @map("total_deductions")
  totalNetPay     Float?  @map("total_net_pay")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")
  
  company         Company   @relation(fields: [companyId], references: [id])
  payrollDetails  PayrollDetail[]

  @@index([companyId])
  @@index([payrollMonth, payrollYear])
  @@map("payroll_runs")
}

model PayrollDetail {
  id              String    @id @default(uuid())
  payrollRunId    String    @map("payroll_run_id")
  employeeId      String    @map("employee_id")
  
  // Earnings
  basicSalary     Float?  @default(0) @map("basic_salary")
  hra             Float?  @default(0)
  specialAllowance Float? @default(0) @map("special_allowance")
  otherAllowances Float?  @default(0) @map("other_allowances")
  grossEarnings   Float?  @map("gross_earnings")
  
  // Deductions
  pfEmployee      Float?  @default(0) @map("pf_employee")
  esicEmployee    Float?  @default(0) @map("esic_employee")
  pt              Float?  @default(0) @map("professional_tax")
  tds             Float?  @default(0)
  totalDeductions Float?  @map("total_deductions")
  
  // Net
  netPay          Float?  @map("net_pay")
  
  // Attendance Context
  payableDays     Float?  @map("payable_days")
  
  payrollRun      PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee        Employee   @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  @@unique([payrollRunId, employeeId])
  @@map("payroll_details")
}

// ============================================================================
// 8. OTHERS (LOANS, COMPLIANCE, AUDIT)
// ============================================================

model Loan {
  id              String    @id @default(uuid())
  employeeId      String    @map("employee_id")
  companyId       String    @map("company_id")
  loanAmount      Float   @map("loan_amount")
  status          String    @default("Pending")
  
  company         Company   @relation(fields: [companyId], references: [id])
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  repayments      LoanRepayment[]

  @@map("loans")
}

model LoanRepayment {
  id              String    @id @default(uuid())
  loanId          String    @map("loan_id")
  repaymentDate   DateTime  @map("repayment_date")
  amount          Float
  
  loan            Loan      @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@map("loan_repayments")
}

model InvestmentDeclaration {
  id              String    @id @default(uuid())
  employeeId      String    @map("employee_id")
  financialYear   String    @map("financial_year")
  
  // Sections (Simplified for schema)
  total80C        Float?  @default(0) @map("total_80c")
  total80D        Float?  @default(0) @map("total_80d")
  hraRentPaid     Float?  @default(0) @map("hra_annual_rent")
  
  status          String    @default("Draft")
  
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, financialYear])
  @@map("investment_declarations")
}

model ComplianceLog {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  complianceType  String    @map("compliance_type")
  periodMonth     Int       @map("period_month")
  periodYear      Int       @map("period_year")
  status          String    @default("Pending")
  
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("compliance_logs")
}

model AuditLog {
  id              String    @id @default(uuid())
  userId          String?   @map("user_id")
  action          String
  entityType      String?   @map("entity_type")
  entityId        String?   @map("entity_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  
  user            User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  key         String   @map("setting_key")
  value       String   @map("setting_value") // JSON stored as string for SQLite compatibility
  
  company     Company? @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
  @@map("system_settings")
}
